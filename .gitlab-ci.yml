image: hatsoftwares/lstu-test-ci:latest
stages:
  - podcheck
  - carton
  - carton_bdd
  - tests_sqlite
  - tests_postgresql
  - tests_mysql
before_script:
  - rm -f *db
variables:
  POSTGRES_DB: lstu
  POSTGRES_USER: lstu
  POSTGRES_PASSWORD: lstu
  MYSQL_DATABASE: lstu
  MYSQL_USER: lstu
  MYSQL_PASSWORD: lstu

### Jobs templates
##
#
.carton_bdd_template: &carton_bdd_definition
  stage: carton_bdd
  retry: 2
  artifacts:
    paths:
      - local/
  dependencies:
    - carton
  when: always
.sqlite_template: &sqlite_definition
  stage: tests_sqlite
  retry: 2
  dependencies:
    - carton_sqlite
  coverage: '/Total .*\d+\.\d+/'
.pg_template: &pg_definition
  stage: tests_postgresql
  retry: 2
  dependencies:
    - carton_postgresql
  services:
    - postgres:9.6
  coverage: '/Total .*\d+\.\d+/'
.mysql_template: &mysql_definition
  stage: tests_mysql
  retry: 2
  dependencies:
    - carton_mysql
  services:
    - mariadb:10.1
  coverage: '/Total .*\d+\.\d+/'

### Podcheck
##
#
podcheck:
  stage: podcheck
  script:
    - make podcheck

### Install common dependencies
##
#
carton:
  stage: carton
  artifacts:
    paths:
      - local/
  dependencies: []
  script:
    - carton install --verbose --deployment --without=sqlite --without=postgresql --without=mysql
  when: always
  retry: 2

### Install DB related dependencies
##
#
carton_sqlite:
  <<: *carton_bdd_definition
  script:
    - carton install --verbose --deployment --without=postgresql --without=mysql
carton_postgresql:
  <<: *carton_bdd_definition
  script:
    - carton install --verbose --deployment --without=sqlite --without=mysql
carton_mysql:
  <<: *carton_bdd_definition
  script:
    - carton install --verbose --deployment --without=sqlite --without=postgresql

### SQLite tests
##
#
sqlite1:
  <<: *sqlite_definition
  script:
    - carton install --deployment --without=postgresql --without=mysql
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/sqlite1.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/sqlite1.conf carton exec cover --ignore_re '^local'
sqlite2:
  <<: *sqlite_definition
  script:
    - carton install --deployment --without=postgresql --without=mysql
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/sqlite2.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/sqlite2.conf carton exec cover --ignore_re '^local'
sqlite3:
  <<: *sqlite_definition
  script:
    - carton install --deployment --without=postgresql --without=mysql
    - MOJO_CONFIG=t/sqlite3.conf make minion &
    - sleep 5
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/sqlite3.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/sqlite3.conf carton exec cover --ignore_re '^local'

### PostgreSQL tests
##
#
postgresql1:
  <<: *pg_definition
  script:
    - carton install --deployment --without=sqlite --without=mysql
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/postgresql1.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/postgresql1.conf carton exec cover --ignore_re '^local'
postgresql2:
  <<: *pg_definition
  script:
    - carton install --deployment --without=sqlite --without=mysql
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/postgresql2.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/postgresql2.conf carton exec cover --ignore_re '^local'
postgresql3:
  <<: *pg_definition
  script:
    - carton install --deployment --without=sqlite --without=mysql
    - MOJO_CONFIG=t/postgresql3.conf make minion &
    - sleep 5
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/postgresql3.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/postgresql3.conf carton exec cover --ignore_re '^local'

### MySQL tests
##
#
mysql1:
  <<: *mysql_definition
  script:
    - carton install --deployment --without=sqlite --without=postgresql
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/mysql1.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/mysql1.conf carton exec cover --ignore_re '^local'
mysql2:
  <<: *mysql_definition
  script:
    - carton install --deployment --without=sqlite --without=postgresql
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/mysql2.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/mysql2.conf carton exec cover --ignore_re '^local'
mysql3:
  <<: *mysql_definition
  script:
    - carton install --deployment --without=sqlite --without=postgresql
    - MOJO_CONFIG=t/mysql3.conf make minion &
    - sleep 5
    - PERL5OPT='-Ilib/' HARNESS_PERL_SWITCHES='-MDevel::Cover' MOJO_CONFIG=t/mysql3.conf make test
    - PERL5OPT='-Ilib/' MOJO_CONFIG=t/mysql3.conf carton exec cover --ignore_re '^local'
