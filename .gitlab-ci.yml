image: hatsoftwares/lstu-test-ci:latest
stages:
  - sqlite
  - postgresql
  - mysql
before_script:
  - rm -f *db
sqlite1:
  stage: sqlite
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    paths:
      - local/
  script:
    - make podcheck
    - carton install --deployment --without=postgresql --without=mysql
    - MOJO_CONFIG=t/sqlite1.conf make test
  when: always
sqlite2:
  stage: sqlite
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    policy: pull
    paths:
      - local/
  dependencies:
    - sqlite1
  script:
    - carton install --deployment --without=postgresql --without=mysql
    - MOJO_CONFIG=t/sqlite2.conf make test
  when: always
sqlite3:
  stage: sqlite
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    policy: pull
    paths:
      - local/
  dependencies:
    - sqlite1
  script:
    - carton install --deployment --without=postgresql --without=mysql
    - MOJO_CONFIG=t/sqlite3.conf make minion &
    - sleep 5
    - MOJO_CONFIG=t/sqlite3.conf make test
  when: always
postgresql1:
  stage: postgresql
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    paths:
      - local/
  services:
    - postgres:9.6
  script:
    - carton install --deployment --without=sqlite --without=mysql
    - service postgresql restart
    - sleep 10
    - service postgresql status
    - MOJO_CONFIG=t/postgresql1.conf make test
  when: always
postgresql2:
  stage: postgresql
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    policy: pull
    paths:
      - local/
  services:
    - postgres:9.6
  dependencies:
    - postgresql1
  script:
    - carton install --deployment --without=sqlite --without=mysql
    - service postgresql restart
    - sleep 10
    - service postgresql status
    - MOJO_CONFIG=t/postgresql2.conf make test
  when: always
postgresql3:
  stage: postgresql
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    policy: pull
    paths:
      - local/
  services:
    - postgres:9.6
  dependencies:
    - postgresql1
  script:
    - carton install --deployment --without=sqlite --without=mysql
    - service postgresql restart
    - sleep 10
    - service postgresql status
    - su -c "psql -f t/test.sql" postgres
    - MOJO_CONFIG=t/postgresql3.conf make minion &
    - sleep 5
    - MOJO_CONFIG=t/postgresql3.conf make test
  when: always
mysql1:
  stage: mysql
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    paths:
      - local/
  services:
    - mariadb:20.1
  script:
    - carton install --deployment --without=sqlite --without=postgresql
    - service postgresql restart
    - sleep 10
    - service postgresql status
    - postgresql -u root < t/test_mysql.sql
    - MOJO_CONFIG=t/postgresql1.conf make test
  when: always
mysql2:
  stage: mysql
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    policy: pull
    paths:
      - local/
  services:
    - mariadb:20.1
  dependencies:
    - mysql1
  script:
    - carton install --deployment --without=sqlite --without=postgresql
    - service mysql restart
    - sleep 10
    - service mysql status
    - mysql -u root < t/test_mysql.sql
    - MOJO_CONFIG=t/mysql2.conf make test
  when: always
mysql3:
  stage: mysql
  cache:
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    untracked: true
    policy: pull
    paths:
      - local/
  services:
    - mariadb:20.1
  dependencies:
    - mysql1
  script:
    - carton install --deployment --without=sqlite --without=postgresql
    - service mysql restart
    - sleep 10
    - service mysql status
    - mysql -u root < t/test_mysql.sql
    - MOJO_CONFIG=t/mysql3.conf make minion &
    - sleep 5
    - MOJO_CONFIG=t/mysql3.conf make test
  when: always

variables:
  POSTGRES_DB: lstu
  POSTGRES_USER: lstu
  POSTGRES_PASSWORD: lstu
  MYSQL_DATABASE: lstu
  MYSQL_USER: lstu
  MYSQL_PASSWORD: lstu
