image: debian:jessie
stages:
  - sqlite
  - postgresql
before_script:
  - apt-get update
  - apt-get install -y build-essential libssl-dev openssl perl-doc libpq-dev
  - echo yes | cpan Carton
  - carton install
  - rm -f *db
sqlite:
  stage: sqlite
  script:
    - MOJO_CONFIG=t/sqlite1.conf make test
    - MOJO_CONFIG=t/sqlite2.conf make test
    - make minion &
    - MOJO_CONFIG=t/sqlite3.conf make test
  tags:
    - Debian
    - Jessie
postgresql:
  stage: postgresql
  script:
    - apt-get install -y postgresql
    - service postgresql start
    - sleep 2
    - service postgresql status
    - su -c "psql -f t/test.sql" postgres
    - MOJO_CONFIG=t/postgresql1.conf make test
    - MOJO_CONFIG=t/postgresql2.conf make test
    - make minion &
    - MOJO_CONFIG=t/postgresql3.conf make test
  tags:
    - Debian
    - Jessie
