image: debian:jessie
stages:
  - sqlite
  - postgresql
before_script:
  - apt-get update
  - apt-get install -y build-essential libssl-dev openssl perl-doc libpq-dev
  - echo yes | cpan Carton
  - carton install
  - cp lstu.conf.template lstu.conf
  - sed -i -e "s@#contact@contact@" -e "s@#adminpwd.*@adminpwd => 'toto',@" -e "s@#db_path.*@db_path => 'test.db',@" -e "s@#pgdb.*@pgdb => {database => 'lstu', host     => 'localhost', user => 'lstu', pwd => 'lstu'},@" lstu.conf
sqlite:
  stage: sqlite
  script:
    - rm -f test.db
    - make test
    - sed -i -e "s@ \(adminpwd.*\)@ \#\1@" -e "s@#hashed_adminpwd.*@hashed_adminpwd => '31f7a65e315586ac198bd798b6629ce4903d0899476d5741a9f32e2e521b6a66',@" lstu.conf
    - rm -f test.db
    - make test
    - sed -i -e "s@#minion.*@minion => { enabled => 1, db_path => 'minion.db' },@" lstu.conf
    - rm -f test.db minion.db
    - make minion &
    - make test
  tags:
    - Debian
    - Jessie
postgresql:
  stage: postgresql
  script:
    - apt-get install -y postgresql
    - su -c "psql -f t/test.sql" postgres
    - sed -i -e "s@#dbtype =>.*@dbtype => 'postgresql'@" lstu.conf
    - make test
    - sed -i -e "s@ \(adminpwd.*\)@ \#\1@" -e "s@#hashed_adminpwd.*@hashed_adminpwd => '31f7a65e315586ac198bd798b6629ce4903d0899476d5741a9f32e2e521b6a66',@" lstu.conf
    - make test
    - sed -i -e "s@#minion.*@minion => { enabled => 1, db_path => 'minion.db' },@" lstu.conf
    - rm -f minion.db
    - make minion &
    - make test
  tags:
    - Debian
    - Jessie
